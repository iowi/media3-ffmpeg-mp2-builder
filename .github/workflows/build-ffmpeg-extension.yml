name: Media3 FFmpeg MP2 Builder (v7a & v8a)

on:
  workflow_dispatch:

jobs:
  build-extension:
    runs-on: ubuntu-latest
    env:
      NDK_VERSION: r26b
      MEDIA3_VERSION: 1.3.1
      FFMPEG_VERSION: release/6.0

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Install Build Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y yasm nasm pkg-config

      - name: Setup NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: Clone Media3 & FFmpeg
        run: |
          git clone --depth 1 --branch ${{ env.MEDIA3_VERSION }} https://github.com/androidx/media.git
          
          # 根据 1.3.1 官方规范，模块路径指向 src/main
          FFMPEG_MODULE_PATH=$GITHUB_WORKSPACE/media/libraries/decoder_ffmpeg/src/main
          echo "FFMPEG_MODULE_PATH=$FFMPEG_MODULE_PATH" >> $GITHUB_ENV
          
          # 克隆 FFmpeg 源码到 jni 目录
          cd $FFMPEG_MODULE_PATH/jni
          git clone --depth 1 --branch ${{ env.FFMPEG_VERSION }} git://source.ffmpeg.org/ffmpeg ffmpeg

      - name: Build FFmpeg Native Libraries (arm64 & v7a)
        run: |
          cd ${{ env.FFMPEG_MODULE_PATH }}/jni
          chmod +x build_ffmpeg.sh
          
          # 【提速优化】尝试在脚本中安全剔除 x86 架构。
          # 即使脚本格式未来有变导致替换失败，它也会静默 fallback 去编译全部 4 个架构，绝不报错中断。
          sed -i 's/armeabi-v7a arm64-v8a x86 x86_64/armeabi-v7a arm64-v8a/g' build_ffmpeg.sh || true
          
          # 【核心！通过原生参数传递解码器】
          # 我们把 mp2, mp2float 以及其他常见的音频解码器直接塞进数组里
          ENABLED_DECODERS=(mp3 mp2 mp2float aac flac vorbis opus)
          
          echo "==== 开始执行 Media3 原生编译脚本 ===="
          # 参数说明 (严格对应 1.3.1 官方要求):
          # $1: 扩展模块的 src/main 路径
          # $2: NDK 路径
          # $3: 宿主系统 (linux-x86_64)
          # $4: ANDROID_ABI (最低兼容版本，官方建议为 21)
          # $5及以后: 你想要启用的所有解码器！
          ./build_ffmpeg.sh \
            "${{ env.FFMPEG_MODULE_PATH }}" \
            "${{ steps.setup-ndk.outputs.ndk-path }}" \
            "linux-x86_64" \
            "21" \
            "${ENABLED_DECODERS[@]}"

      - name: Build AAR with Gradle
        run: |
          cd $GITHUB_WORKSPACE/media
          ./gradlew lib-decoder-ffmpeg:assembleRelease

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: media3-ffmpeg-mp2-aar
          path: media/libraries/decoder_ffmpeg/build/outputs/aar/*.aar
