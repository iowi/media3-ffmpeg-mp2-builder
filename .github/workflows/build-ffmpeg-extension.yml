name: Build Media3 FFmpeg Extension with MP2 Support (ARM only)

# 允许手动触发工作流
on:
  workflow_dispatch:
    inputs:
      media3_version:
        description: 'Media3 Branch or Tag (e.g., main, 1.2.0)'
        required: true
        default: 'main'
      ffmpeg_version:
        description: 'FFmpeg Release Tag (e.g., release/6.0)'
        required: true
        default: 'release/6.0'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b
          local-cache: true

      - name: Clone Media3 Source
        run: |
          git clone --branch ${{ github.event.inputs.media3_version }} https://github.com/androidx/media.git
          echo "MEDIA3_PATH=$GITHUB_WORKSPACE/media" >> $GITHUB_ENV
          echo "FFMPEG_MODULE_PATH=$GITHUB_WORKSPACE/media/libraries/decoder_ffmpeg/src/main" >> $GITHUB_ENV

      - name: Clone FFmpeg Source
        run: |
          cd ${{ env.FFMPEG_MODULE_PATH }}/jni
          git clone git://source.ffmpeg.org/ffmpeg ffmpeg
          cd ffmpeg
          git checkout ${{ github.event.inputs.ffmpeg_version }}

      - name: Inject MP2 Decoder Support
        run: |
          cd ${{ env.FFMPEG_MODULE_PATH }}/jni
          
          # 首先检查文件是否存在
          if [ ! -f "build_ffmpeg.sh" ]; then
            echo "错误: build_ffmpeg.sh 文件不存在"
            exit 1
          fi
          
          # 备份原始文件
          cp build_ffmpeg.sh build_ffmpeg.sh.bak
          
          # 修改脚本，只编译 ARM 架构
          echo "修改编译脚本，只保留 ARM 架构支持..."
          
          # 在脚本开头添加只编译 ARM 的配置
          sed -i 's/^# ARCHS = .*/# ARCHS = (armv7-a arm64 x86 x86_64)\nONLY_ARM=true\nARCHS=(armv7-a arm64)/' build_ffmpeg.sh
          
          # 注入 MP2 解码器支持
          sed -i 's/--enable-decoder=mp3 \\/--enable-decoder=mp3 \\\n    --enable-decoder=mp2 \\\n    --enable-decoder=mp2float \\/g' build_ffmpeg.sh
          
          # 验证注入是否成功
          echo "==== 验证 MP2 解码器是否添加成功 ===="
          grep -A3 -B3 "enable-decoder" build_ffmpeg.sh || true

      - name: Create Custom Build Script (ARM only)
        run: |
          cd ${{ env.FFMPEG_MODULE_PATH }}/jni
          
          # 创建自定义编译脚本，只编译 ARM 架构
          cat > build_ffmpeg_arm_only.sh << 'EOF'
#!/bin/bash
# 只编译 ARM 架构的 FFmpeg

set -e  # 遇到错误立即退出

if [ $# -lt 2 ]; then
    echo "Usage: $0 <ffmpeg-source-dir> <ndk-path> [host-platform]"
    exit 1
fi

FFMPEG_DIR=$1
NDK_PATH=$2
HOST_PLATFORM=${3:-linux-x86_64}

echo "FFMPEG_DIR: $FFMPEG_DIR"
echo "NDK_PATH: $NDK_PATH"
echo "HOST_PLATFORM: $HOST_PLATFORM"

# 设置 NDK 工具链
export ANDROID_NDK=$NDK_PATH
export PATH=$NDK_PATH/toolchains/llvm/prebuilt/$HOST_PLATFORM/bin:$PATH

# 定义 ARM 架构
# 只编译 ARMv7-a 和 ARM64
ARCHS=("armv7-a" "arm64")
TOOLCHAIN_PREFIXES=(
    "armv7a-linux-androideabi"
    "aarch64-linux-android"
)

# 对应的 API 级别
ANDROID_API=21

# FFmpeg 配置选项
COMMON_OPTIONS="
    --target-os=android
    --enable-cross-compile
    --enable-static
    --disable-shared
    --disable-doc
    --disable-programs
    --disable-everything
    --disable-avdevice
    --disable-postproc
    --enable-avcodec
    --enable-avformat
    --enable-avutil
    --enable-swresample
    --enable-swscale
    --enable-decoder=mpeg4
    --enable-decoder=h264
    --enable-decoder=hevc
    --enable-decoder=aac
    --enable-decoder=mp3
    --enable-decoder=mp2
    --enable-decoder=mp2float
    --enable-demuxer=mov
    --enable-demuxer=matroska
    --enable-demuxer=mp4
    --enable-demuxer=mpegps
    --enable-demuxer=mpegts
    --enable-demuxer=flv
    --enable-parser=h264
    --enable-parser=hevc
    --enable-parser=aac
    --enable-parser=mpegaudio
    --enable-protocol=file
"

# 遍历 ARM 架构进行编译
for i in "${!ARCHS[@]}"; do
    ARCH="${ARCHS[$i]}"
    TOOLCHAIN_PREFIX="${TOOLCHAIN_PREFIXES[$i]}"
    
    echo "========================================"
    echo "编译架构: $ARCH"
    echo "工具链前缀: $TOOLCHAIN_PREFIX"
    echo "========================================"
    
    # 设置编译器
    CC="${TOOLCHAIN_PREFIX}${ANDROID_API}-clang"
    CXX="${TOOLCHAIN_PREFIX}${ANDROID_API}-clang++"
    AR="llvm-ar"
    LD="${TOOLCHAIN_PREFIX}${ANDROID_API}-clang"
    
    # 创建输出目录
    OUTPUT_DIR="$(pwd)/ffmpeg-build/$ARCH"
    mkdir -p "$OUTPUT_DIR"
    
    # 配置 FFmpeg
    cd "$FFMPEG_DIR"
    
    # 根据架构设置特定参数
    case $ARCH in
        armv7-a)
            EXTRA_CFLAGS="-march=armv7-a -mfloat-abi=softfp -mfpu=neon"
            ;;
        arm64)
            EXTRA_CFLAGS="-march=armv8-a"
            ;;
    esac
    
    ./configure \
        --prefix="$OUTPUT_DIR" \
        --arch="$ARCH" \
        --cc="$CC" \
        --cxx="$CXX" \
        --ar="$AR" \
        --ld="$LD" \
        --extra-cflags="$EXTRA_CFLAGS" \
        --extra-ldflags="" \
        $COMMON_OPTIONS
    
    # 编译和安装
    make -j$(nproc)
    make install
    make clean
    
    echo "✓ $ARCH 编译完成"
done

echo "所有 ARM 架构编译完成！"
EOF

          chmod +x build_ffmpeg_arm_only.sh

      - name: Build FFmpeg core libraries (ARM only)
        run: |
          cd ${{ env.FFMPEG_MODULE_PATH }}/jni
          
          # 检查 FFmpeg 源码是否存在
          if [ ! -d "ffmpeg" ]; then
            echo "错误: FFmpeg 源码目录不存在"
            exit 1
          fi
          
          # 使用自定义脚本编译（只编译 ARM）
          echo "开始编译 FFmpeg (ARM only)..."
          ./build_ffmpeg_arm_only.sh \
            ${{ env.FFMPEG_MODULE_PATH }}/jni/ffmpeg \
            ${{ steps.setup-ndk.outputs.ndk-path }} \
            linux-x86_64
          
          # 检查编译结果
          if [ $? -eq 0 ]; then
            echo "✓ FFmpeg ARM 编译成功"
            
            # 显示编译结果
            echo "==== 编译生成的库文件 ===="
            find ffmpeg-build -name "*.a" -o -name "*.so" | xargs ls -la
          else
            echo "✗ FFmpeg 编译失败"
            exit 1
          fi

      - name: Patch Media3 build.gradle for ARM only
        run: |
          cd ${{ env.MEDIA3_PATH }}/libraries/decoder_ffmpeg
          
          # 修改 build.gradle 只包含 ARM 架构
          sed -i 's/abiFilters "armeabi-v7a", "arm64-v8a", "x86", "x86_64"/abiFilters "armeabi-v7a", "arm64-v8a"/' build.gradle
          
          echo "==== 修改后的 build.gradle ABI 配置 ===="
          grep -A5 "abiFilters" build.gradle || true

      - name: Assemble Media3 FFmpeg AAR via Gradle
        run: |
          cd ${{ env.MEDIA3_PATH }}
          
          # 确保 gradlew 有执行权限
          chmod +x gradlew
          
          # 只编译 ARM 版本
          echo "开始编译 AAR 包 (ARM only)..."
          ./gradlew lib-decoder-ffmpeg:assembleRelease \
            -Pandroid.defaultConfig.abiFilters="armeabi-v7a,arm64-v8a"
          
          # 检查编译结果
          if [ $? -eq 0 ]; then
            echo "✓ AAR 编译成功"
          else
            echo "✗ AAR 编译失败"
            exit 1
          fi

      - name: Verify AAR file and check architectures
        run: |
          # 检查 AAR 文件是否生成
          AAR_PATH="${{ env.MEDIA3_PATH }}/libraries/decoder_ffmpeg/build/outputs/aar"
          if [ -d "$AAR_PATH" ] && [ "$(ls -A $AAR_PATH/*.aar 2>/dev/null)" ]; then
            echo "✓ AAR 文件已生成："
            AAR_FILE=$(ls $AAR_PATH/*.aar | head -1)
            ls -la $AAR_FILE
            
            # 解压 AAR 检查包含的架构
            echo "==== 检查 AAR 中包含的架构 ===="
            mkdir -p aar_content
            unzip -q $AAR_FILE -d aar_content
            
            if [ -d "aar_content/jni" ]; then
              echo "包含的 ABI 架构："
              find aar_content/jni -type f | sort
            else
              echo "未找到 JNI 目录，检查 lib 目录："
              find aar_content -name "*.so" | sort
            fi
            
            # 清理
            rm -rf aar_content
          else
            echo "✗ AAR 文件未生成"
            exit 1
          fi

      - name: Upload FFmpeg Extension AAR
        uses: actions/upload-artifact@v4
        with:
          name: media3-ffmpeg-extension-mp2-arm-only
          path: media/libraries/decoder_ffmpeg/build/outputs/aar/*.aar
          retention-days: 7
          if-no-files-found: error

      - name: Upload build logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            media/**/build/outputs/logs/**
            media/**/build/reports/**
            media/libraries/decoder_ffmpeg/src/main/jni/ffmpeg-build/**/*.log
          retention-days: 7
