name: Build Media3 FFmpeg Extension with MP2 Support (ARM only)

on:
  workflow_dispatch:
    inputs:
      media3_version:
        description: 'Media3 Branch or Tag (e.g., main, 1.2.0)'
        required: true
        default: 'main'
      ffmpeg_version:
        description: 'FFmpeg Release Tag (e.g., release/6.0)'
        required: true
        default: 'release/6.0'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      MEDIA3_PATH: ${{ github.workspace }}/media
      FFMPEG_JNI_PATH: ${{ github.workspace }}/media/libraries/decoder_ffmpeg/src/main/jni

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b
          local-cache: true

      - name: Prepare Source
        run: |
          git clone --branch ${{ github.event.inputs.media3_version }} https://github.com/androidx/media.git "$MEDIA3_PATH"
          cd "$FFMPEG_JNI_PATH"
          git clone git://source.ffmpeg.org/ffmpeg ffmpeg
          cd ffmpeg && git checkout ${{ github.event.inputs.ffmpeg_version }}

      - name: Build FFmpeg
        run: |
          cd "$FFMPEG_JNI_PATH"
          sed -i '/--enable-decoder=mp3/a \    --enable-decoder=mp2 \\\n    --enable-decoder=mp2float \\' build_ffmpeg.sh
          cat > build_ffmpeg_arm_only.sh << 'EOF'
          #!/bin/bash
          set -e
          FFMPEG_DIR=$1
          NDK_PATH=$2
          TOOLCHAIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64
          export PATH=$TOOLCHAIN/bin:$PATH
          cd "$FFMPEG_DIR"
          make distclean || true
          ./configure \
            --target-os=android \
            --arch=aarch64 \
            --cpu=armv8-a \
            --enable-cross-compile \
            --cc=aarch64-linux-android21-clang \
            --cross-prefix=aarch64-linux-android- \
            --sysroot=$TOOLCHAIN/sysroot \
            --extra-cflags="-Os -fPIC" \
            --enable-static \
            --disable-shared \
            --disable-everything \
            --enable-avcodec --enable-avformat --enable-avutil --enable-swresample \
            --enable-decoder=h264,hevc,aac,mp3,mp2,mp2float \
            --disable-doc --disable-programs || (cat ffbuild/config.log && exit 1)
          make -j$(nproc)
          EOF
          chmod +x build_ffmpeg_arm_only.sh
          ./build_ffmpeg_arm_only.sh "$(pwd)/ffmpeg" "${{ steps.setup-ndk.outputs.ndk-path }}"

      - name: Assemble AAR
        run: |
          cd "$MEDIA3_PATH"
          chmod +x gradlew
          ./gradlew :libraries:decoder_ffmpeg:assembleRelease -Pandroid.defaultConfig.abiFilters="armeabi-v7a,arm64-v8a"

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: media3-ffmpeg-extension-arm
          path: ${{ env.MEDIA3_PATH }}/libraries/decoder_ffmpeg/build/outputs/aar/*.aar
