name: Build Media3 FFmpeg Extension with MP2 Support (ARM only)

on:
  workflow_dispatch:
    inputs:
      media3_version:
        description: 'Media3 Branch or Tag (e.g., main, 1.2.0)'
        required: true
        default: 'main'
      ffmpeg_version:
        description: 'FFmpeg Release Tag (e.g., release/6.0)'
        required: true
        default: 'release/6.0'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      MEDIA3_PATH: ${{ github.workspace }}/media
      FFMPEG_JNI_PATH: ${{ github.workspace }}/media/libraries/decoder_ffmpeg/src/main/jni

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26b
          local-cache: true

      - name: Clone Media3 Source
        run: |
          git clone --branch ${{ github.event.inputs.media3_version }} https://github.com/androidx/media.git "$MEDIA3_PATH"

      - name: Setup FFmpeg Source
        run: |
          cd "$FFMPEG_JNI_PATH"
          git clone git://source.ffmpeg.org/ffmpeg ffmpeg
          cd ffmpeg
          git checkout ${{ github.event.inputs.ffmpeg_version }}

      - name: Inject MP2 Support
        run: |
          cd "$FFMPEG_JNI_PATH"
          sed -i '/--enable-decoder=mp3/a \    --enable-decoder=mp2 \\\n    --enable-decoder=mp2float \\' build_ffmpeg.sh

      - name: Run Build
        run: |
          cd "$FFMPEG_JNI_PATH"
          # 注意：请确保你的 build_ffmpeg_arm_only.sh 已正确创建并赋权
          chmod +x build_ffmpeg_arm_only.sh
          ./build_ffmpeg_arm_only.sh "$(pwd)/ffmpeg" "${{ steps.setup-ndk.outputs.ndk-path }}"

      - name: Assemble AAR
        run: |
          cd "$MEDIA3_PATH"
          chmod +x gradlew
          ./gradlew :libraries:decoder_ffmpeg:assembleRelease -Pandroid.defaultConfig.abiFilters="armeabi-v7a,arm64-v8a"

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: media3-ffmpeg-extension-arm
          path: ${{ env.MEDIA3_PATH }}/libraries/decoder_ffmpeg/build/outputs/aar/*.aar
