name: Media3 FFmpeg MP2 Builder

on:
  workflow_dispatch: # 支持手动点击运行

jobs:
  build-extension:
    runs-on: ubuntu-latest
    
    # 设置环境变量方便引用
    env:
      NDK_VERSION: r26b
      MEDIA3_VERSION: 1.3.1  # 你可以修改为你需要的版本号或 main
      FFMPEG_VERSION: release/6.0

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y yasm nasm pkg-config

      - name: Setup NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: Clone Media3 & FFmpeg
        run: |
          # 克隆 Media3
          git clone --depth 1 --branch ${{ env.MEDIA3_VERSION }} https://github.com/androidx/media.git
          
          # 定义路径变量
          JNI_PATH=$GITHUB_WORKSPACE/media/libraries/decoder_ffmpeg/src/main/jni
          echo "JNI_PATH=$JNI_PATH" >> $GITHUB_ENV
          
          # 克隆 FFmpeg 到指定目录
          cd $JNI_PATH
          git clone --depth 1 --branch ${{ env.FFMPEG_VERSION }} git://source.ffmpeg.org/ffmpeg ffmpeg

      - name: Force Inject MP2 Support
        run: |
          cd ${{ env.JNI_PATH }}
          
          # 【核心修复】不使用匹配替换，直接在脚本最前面强行插入解码器配置
          # 我们通过在 COMMON_OPTIONS 变量定义后追加参数来确保生效
          sed -i '/COMMON_OPTIONS=(/a \    --enable-decoder=mp2 \\\n    --enable-decoder=mp2float \\' build_ffmpeg.sh
          
          echo "==== 检查脚本是否修改成功 ===="
          grep -C 3 "mp2" build_ffmpeg.sh

      - name: Build FFmpeg Native Libraries
        run: |
          cd ${{ env.JNI_PATH }}
          chmod +x build_ffmpeg.sh
          # 执行编译，针对所有主流架构
          ./build_ffmpeg.sh "${{ env.JNI_PATH }}/ffmpeg" "${{ steps.setup-ndk.outputs.ndk-path }}" "linux-x86_64"

      - name: Build AAR with Gradle
        run: |
          cd $GITHUB_WORKSPACE/media
          # 这一步会将上一步生成的 .so 打包进 AAR
          ./gradlew lib-decoder-ffmpeg:assembleRelease

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: media3-ffmpeg-mp2-aar
          path: media/libraries/decoder_ffmpeg/build/outputs/aar/*.aar
