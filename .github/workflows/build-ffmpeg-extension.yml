name: Build Media3 FFmpeg Extension with MP2 Support

# 允许手动触发工作流
on:
  workflow_dispatch:
    inputs:
      media3_version:
        description: 'Media3 Branch or Tag (e.g., main, 1.2.0)'
        required: true
        default: 'main'
      ffmpeg_version:
        description: 'FFmpeg Release Tag (e.g., release/6.0)'
        required: true
        default: 'release/6.0'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          # Media3 官方推荐的 NDK 版本通常为 26 左右
          ndk-version: r26b
          local-cache: true

      - name: Clone Media3 Source
        run: |
          git clone --branch ${{ github.event.inputs.media3_version }} https://github.com/androidx/media.git
          echo "MEDIA3_PATH=$GITHUB_WORKSPACE/media" >> $GITHUB_ENV
          echo "FFMPEG_MODULE_PATH=$GITHUB_WORKSPACE/media/libraries/decoder_ffmpeg/src/main" >> $GITHUB_ENV

      - name: Clone FFmpeg Source
        run: |
          cd ${{ env.FFMPEG_MODULE_PATH }}/jni
          git clone git://source.ffmpeg.org/ffmpeg ffmpeg
          cd ffmpeg
          git checkout ${{ github.event.inputs.ffmpeg_version }}

      - name: Inject MP2 Decoder Support
        run: |
          cd ${{ env.FFMPEG_MODULE_PATH }}/jni
          # 使用 sed 命令，在 --enable-decoder=mp3 后面注入 mp2 和 mp2float 解码器
          sed -i 's/--enable-decoder=mp3 \\/--enable-decoder=mp3 \\\n    --enable-decoder=mp2 \\\n    --enable-decoder=mp2float \\/g' build_ffmpeg.sh
          
          # 验证是否注入成功
          echo "==== build_ffmpeg.sh 包含 MP2 的部分 ===="
          grep -C 2 "mp2" build_ffmpeg.sh

      - name: Build FFmpeg core libraries
        run: |
          cd ${{ env.FFMPEG_MODULE_PATH }}/jni
          # 执行 Media3 提供的编译脚本
          # 参数: <ffmpeg源码路径> <NDK路径> <宿主平台>
          ./build_ffmpeg.sh ${{ env.FFMPEG_MODULE_PATH }}/jni/ffmpeg ${{ steps.setup-ndk.outputs.ndk-path }} linux-x86_64

      - name: Assemble Media3 FFmpeg AAR via Gradle
        run: |
          cd ${{ env.MEDIA3_PATH }}
          # 编译 FFmpeg extension 为 AAR 包
          ./gradlew lib-decoder-ffmpeg:assembleRelease

      - name: Upload FFmpeg Extension AAR
        uses: actions/upload-artifact@v4
        with:
          name: media3-ffmpeg-extension-mp2
          path: media/libraries/decoder_ffmpeg/build/outputs/aar/*.aar
          retention-days: 7
