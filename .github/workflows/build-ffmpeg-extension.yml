name: Build Media3 FFmpeg Extension with MP2 Support

# 允许手动触发工作流
on:
  workflow_dispatch:
    inputs:
      media3_version:
        description: 'Media3 Branch or Tag (e.g., main, 1.2.0)'
        required: true
        default: 'main'
      ffmpeg_version:
        description: 'FFmpeg Release Tag (e.g., release/6.0)'
        required: true
        default: 'release/6.0'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          # Media3 官方推荐的 NDK 版本通常为 26 左右
          ndk-version: r26b
          local-cache: true

      - name: Clone Media3 Source
        run: |
          git clone --branch ${{ github.event.inputs.media3_version }} https://github.com/androidx/media.git
          echo "MEDIA3_PATH=$GITHUB_WORKSPACE/media" >> $GITHUB_ENV
          echo "FFMPEG_MODULE_PATH=$GITHUB_WORKSPACE/media/libraries/decoder_ffmpeg/src/main" >> $GITHUB_ENV

      - name: Clone FFmpeg Source
        run: |
          cd ${{ env.FFMPEG_MODULE_PATH }}/jni
          git clone git://source.ffmpeg.org/ffmpeg ffmpeg
          cd ffmpeg
          git checkout ${{ github.event.inputs.ffmpeg_version }}

      - name: Inject MP2 Decoder Support
        run: |
          cd ${{ env.FFMPEG_MODULE_PATH }}/jni
          
          # 首先检查文件是否存在
          if [ ! -f "build_ffmpeg.sh" ]; then
            echo "错误: build_ffmpeg.sh 文件不存在"
            exit 1
          fi
          
          # 备份原始文件
          cp build_ffmpeg.sh build_ffmpeg.sh.bak
          
          # 显示原始解码器配置
          echo "==== 原始解码器配置 ===="
          grep -C 3 "enable-decoder" build_ffmpeg.sh || echo "未找到解码器配置"
          
          # 使用 sed 命令注入 MP2 解码器
          echo "正在注入 MP2 解码器支持..."
          sed -i 's/--enable-decoder=mp3 \\/--enable-decoder=mp3 \\\n    --enable-decoder=mp2 \\\n    --enable-decoder=mp2float \\/g' build_ffmpeg.sh
          
          # 验证注入是否成功（使用 || true 避免 grep 失败导致工作流终止）
          echo "==== 验证 MP2 解码器是否添加成功 ===="
          if grep -q "enable-decoder=mp2" build_ffmpeg.sh; then
            echo "✓ MP2 解码器添加成功"
            echo "==== 修改后的解码器配置 ===="
            grep -A5 -B5 "enable-decoder" build_ffmpeg.sh || true
          else
            echo "⚠️ 警告: 未找到 MP2 解码器配置，检查原始文件格式"
            echo "==== 文件差异对比 ===="
            diff build_ffmpeg.sh.bak build_ffmpeg.sh || true
            echo "==== 完整文件内容 ===="
            cat build_ffmpeg.sh
            # 如果不希望因为注入失败而终止构建，可以注释下一行
            # exit 1
          fi

      - name: Build FFmpeg core libraries
        run: |
          cd ${{ env.FFMPEG_MODULE_PATH }}/jni
          # 设置 NDK 路径
          export ANDROID_NDK=${{ steps.setup-ndk.outputs.ndk-path }}
          
          # 检查 FFmpeg 源码是否存在
          if [ ! -d "ffmpeg" ]; then
            echo "错误: FFmpeg 源码目录不存在"
            exit 1
          fi
          
          # 使脚本可执行
          chmod +x build_ffmpeg.sh
          
          # 执行 Media3 提供的编译脚本
          # 参数: <ffmpeg源码路径> <NDK路径> <宿主平台>
          echo "开始编译 FFmpeg..."
          ./build_ffmpeg.sh ${{ env.FFMPEG_MODULE_PATH }}/jni/ffmpeg ${{ steps.setup-ndk.outputs.ndk-path }} linux-x86_64
          
          # 检查编译结果
          if [ $? -eq 0 ]; then
            echo "✓ FFmpeg 编译成功"
          else
            echo "✗ FFmpeg 编译失败"
            exit 1
          fi

      - name: Assemble Media3 FFmpeg AAR via Gradle
        run: |
          cd ${{ env.MEDIA3_PATH }}
          
          # 确保 gradlew 有执行权限
          chmod +x gradlew
          
          # 编译 FFmpeg extension 为 AAR 包
          echo "开始编译 AAR 包..."
          ./gradlew lib-decoder-ffmpeg:assembleRelease
          
          # 检查编译结果
          if [ $? -eq 0 ]; then
            echo "✓ AAR 编译成功"
          else
            echo "✗ AAR 编译失败"
            exit 1
          fi

      - name: Verify AAR file
        run: |
          # 检查 AAR 文件是否生成
          AAR_PATH="${{ env.MEDIA3_PATH }}/libraries/decoder_ffmpeg/build/outputs/aar"
          if [ -d "$AAR_PATH" ] && [ "$(ls -A $AAR_PATH/*.aar 2>/dev/null)" ]; then
            echo "✓ AAR 文件已生成："
            ls -la $AAR_PATH/*.aar
          else
            echo "✗ AAR 文件未生成"
            exit 1
          fi

      - name: Upload FFmpeg Extension AAR
        uses: actions/upload-artifact@v4
        with:
          name: media3-ffmpeg-extension-mp2
          path: media/libraries/decoder_ffmpeg/build/outputs/aar/*.aar
          retention-days: 7
          if-no-files-found: error

      - name: Upload build logs (if failed)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            media/**/build/outputs/logs/**
            media/**/build/reports/**
          retention-days: 7
