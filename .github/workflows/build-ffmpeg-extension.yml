name: Media3 FFmpeg MP2 Builder

on:
  workflow_dispatch:

jobs:
  build-extension:
    runs-on: ubuntu-latest
    env:
      NDK_VERSION: r26b
      # 明确指定版本，避免 main 分支变动
      MEDIA3_VERSION: 1.3.1  
      FFMPEG_VERSION: release/6.0

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y yasm nasm pkg-config

      - name: Setup NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: ${{ env.NDK_VERSION }}

      - name: Clone Media3 & FFmpeg
        run: |
          git clone --depth 1 --branch ${{ env.MEDIA3_VERSION }} https://github.com/androidx/media.git
          JNI_PATH=$GITHUB_WORKSPACE/media/libraries/decoder_ffmpeg/src/main/jni
          echo "JNI_PATH=$JNI_PATH" >> $GITHUB_ENV
          
          cd $JNI_PATH
          git clone --depth 1 --branch ${{ env.FFMPEG_VERSION }} git://source.ffmpeg.org/ffmpeg ffmpeg

      - name: Force Inject MP2 Support (The Nuclear Option)
        run: |
          cd ${{ env.JNI_PATH }}
          
          # 检查文件
          ls -l build_ffmpeg.sh
          
          # 直接在脚本的第二行（shebang 之后）插入强制开启 MP2 的参数
          # 这样无论后面的 COMMON_OPTIONS 怎么变，这几个参数都会被加入到编译中
          sed -i '2i ENABLED_DECODERS+=(mp2 mp2float)' build_ffmpeg.sh
          
          # 如果脚本里没有使用 ENABLED_DECODERS 变量，我们用最保险的方法：
          # 直接搜索并替换 --enable-decoder=mp3 为支持 mp2 的版本
          # 使用更加模糊的匹配模式
          sed -i 's/--enable-decoder=mp3/--enable-decoder=mp3 --enable-decoder=mp2 --enable-decoder=mp2float/g' build_ffmpeg.sh
          
          echo "==== 验证脚本内容 (显示前 50 行) ===="
          head -n 50 build_ffmpeg.sh | grep "mp2" || echo "Warning: mp2 not found in head, checking full file..."
          grep "mp2" build_ffmpeg.sh

      - name: Build FFmpeg Native Libraries
        run: |
          cd ${{ env.JNI_PATH }}
          chmod +x build_ffmpeg.sh
          ./build_ffmpeg.sh "${{ env.JNI_PATH }}/ffmpeg" "${{ steps.setup-ndk.outputs.ndk-path }}" "linux-x86_64"

      - name: Build AAR with Gradle
        run: |
          cd $GITHUB_WORKSPACE/media
          ./gradlew lib-decoder-ffmpeg:assembleRelease

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: media3-ffmpeg-mp2-aar
          path: media/libraries/decoder_ffmpeg/build/outputs/aar/*.aar
