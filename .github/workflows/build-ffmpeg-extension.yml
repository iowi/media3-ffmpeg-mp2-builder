- name: Build FFmpeg (Inject MP2 & Compile)
        run: |
          cd "$FFMPEG_JNI_PATH"
          
          # 1. 注入补丁（注意这里的路径和空格处理）
          sed -i '/--enable-decoder=mp3/a \    --enable-decoder=mp2 \\\n    --enable-decoder=mp2float \\' build_ffmpeg.sh
          
          # 2. 创建编译脚本 (使用标准路径和显式交叉前缀)
          cat > build_ffmpeg_arm_only.sh << 'EOF'
          #!/bin/bash
          set -e
          FFMPEG_DIR=$1
          NDK_PATH=$2
          
          # NDK r26b 的标准 LLVM 路径
          TOOLCHAIN=$NDK_PATH/toolchains/llvm/prebuilt/linux-x86_64
          export PATH=$TOOLCHAIN/bin:$PATH
          
          cd "$FFMPEG_DIR"
          
          # 彻底清理之前的配置残留
          make distclean || true
          
          # 关键点：--cross-prefix 必须指向 bin 目录下的前缀
          ./configure \
            --target-os=android \
            --arch=aarch64 \
            --cpu=armv8-a \
            --enable-cross-compile \
            --cc=aarch64-linux-android21-clang \
            --cross-prefix=aarch64-linux-android- \
            --nm=llvm-nm \
            --ar=llvm-ar \
            --ranlib=llvm-ranlib \
            --strip=llvm-strip \
            --sysroot=$TOOLCHAIN/sysroot \
            --extra-cflags="-Os -fPIC" \
            --extra-ldflags="-Wl,-Bsymbolic" \
            --enable-static \
            --disable-shared \
            --disable-everything \
            --enable-avcodec --enable-avformat --enable-avutil --enable-swresample \
            --enable-decoder=h264,hevc,aac,mp3,mp2,mp2float \
            --disable-doc \
            --disable-programs || (cat ffbuild/config.log && exit 1)
            
          make -j$(nproc)
          EOF
          
          chmod +x build_ffmpeg_arm_only.sh
          # 这里使用动态路径，避免写死 runner 路径
          ./build_ffmpeg_arm_only.sh "$(pwd)/ffmpeg" "${{ steps.setup-ndk.outputs.ndk-path }}"
